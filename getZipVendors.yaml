AWSTemplateFormatVersion: "2010-09-09"
Transform: "AWS::LanguageExtensions"
Resources:
  getZipVendorsStepFunction:
    Type: "AWS::StepFunctions::StateMachine"
    Properties:
      StateMachineName: getZipVendorsStepFunction
      RoleArn: !GetAtt getZipVendorsRole.Arn
      StateMachineType: EXPRESS
      Tags:
        - Key: createdBy
          Value: jwheeler
      LoggingConfiguration:
        IncludeExecutionData: true
        Level: ALL
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt getZipVendorsLogGroup.Arn
      Definition:
        Comment: Step function to get Zip Vendors
        QueryLanguage: JSONata
        StartAt: GetZipVendors
        States:
          GetZipVendors:
            Type: Task
            Resource: arn:aws:states:::http:invoke
            Arguments:
              Method: GET
              ApiEndpoint: https://api.ziphq.com/vendors
              InvocationConfig:
                ConnectionArn: arn:aws:events:us-east-1:263423265049:connection/ZipAPIkey/a3864131-1c2d-4f9a-8ff2-af64ef2defde
              QueryParameters:
                status: ACTIVE
                include_attributes: true
            Next: IterateOverVendors
          IterateOverVendors:
            Type: Map
            Items: "{% $states.input.ResponseBody.list %}"
            MaxConcurrency: 1
            ItemProcessor:
              ProcessorConfig:
                Mode: INLINE
              StartAt: myPassState
              States:
                myPassState:
                  Type: Pass
                  End: true
            End: true

  getZipVendorsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      Tags:
        - Key: createdBy
          Value: jwheeler
      LogGroupClass: STANDARD
      LogGroupName: /aws/vendedlogs/states/getZipVendors

  getZipVendorsRole:
    Type: "AWS::IAM::Role"
    Properties:
      Path: "/service-role/"
      ManagedPolicyArns:
        - Ref: getZipVendorsCWLogsPolicy
        - Ref: getZipVendorsParameterStorePolicy
        - Ref: getZipVendorsRoleHTTPInvoke
        - Ref: getZipVendorsSecretsmgrPolicy
      MaxSessionDuration: 3600
      RoleName: "getZipVendorsRole"
      Policies:
        - PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Resource: "*"
                Action:
                  - states:StartSyncExecution
                  - states:StartExecution
                Effect: Allow
                Sid: VisualEditor0
          PolicyName: getZipVendorsExecuteStepFunction
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          Action: "sts:AssumeRole"
          Effect: "Allow"
          Principal:
            Service: "states.amazonaws.com"
          Sid: "TrustPolicy1"
  getZipVendorsCWLogsPolicy:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Resource: "*"
            Action:
              - "logs:CreateLogDelivery"
              - "logs:GetLogDelivery"
              - "logs:UpdateLogDelivery"
              - "logs:DeleteLogDelivery"
              - "logs:ListLogDeliveries"
              - "logs:PutResourcePolicy"
              - "logs:DescribeResourcePolicies"
              - "logs:DescribeLogGroups"
            Effect: "Allow"
            Sid: "AllowCloudwatchLogsaccess"
  getZipVendorsParameterStorePolicy:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Resource: "*"
            Action:
              - "ssm:GetParameter"
              - "ssm:GetParameters"
            Effect: "Allow"
            Sid: "VisualEditor0"
  getZipVendorsSecretsmgrPolicy:
    UpdateReplacePolicy: "Retain"
    Type: "AWS::IAM::ManagedPolicy"
    DeletionPolicy: "Retain"
    Properties:
      Path: "/service-role/"
      Description:
        "Allow AWS Step Functions to make an HTTP call with Connection\
        \ credentials on your behalf."
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Resource:
              - !Sub "arn:aws:events:us-east-1:${AWS::AccountId}:connection/*/*"
            Action:
              - "events:RetrieveConnectionCredentials"
            Effect: "Allow"
            Sid: "RetrieveConnectionCredentials1"
          - Resource:
              - !Sub "arn:aws:secretsmanager:us-east-1:${AWS::AccountId}:secret:events!connection/*/*"
            Action:
              - "secretsmanager:GetSecretValue"
              - "secretsmanager:DescribeSecret"
            Effect: "Allow"
            Sid: "GetAndDescribeSecretValue1"
  getZipVendorsRoleHTTPInvoke:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      Path: "/service-role/"
      Description:
        "Allow AWS Step Functions to make an HTTP call with Connection\
        \ credentials on your behalf."
      Groups: []
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          Resource: !Sub "arn:aws:states:us-east-1:${AWS::AccountId}:stateMachine:*"
          Action:
            - "states:InvokeHTTPEndpoint"
          Effect: "Allow"
          Sid: "InvokeHttpEndpoint1"
